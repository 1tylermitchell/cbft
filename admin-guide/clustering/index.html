<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>Clustering cbft - cbft Technical Documentation (0.0 DP)</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify-1.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">cbft Technical Documentation (0.0 DP)</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer's Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../dev-guide/overview">Developer's guide overview</a>
                        </li>
                    
                        <li >
                            <a href="../../dev-guide/concepts">Key concepts</a>
                        </li>
                    
                        <li >
                            <a href="../../dev-guide/index-definitions">Index definitions</a>
                        </li>
                    
                        <li >
                            <a href="../../dev-guide/index-queries">Index queries</a>
                        </li>
                    
                        <li >
                            <a href="../../dev-guide/performance">Performance</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../api-ref">API Reference</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Administrator's Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../overview">Administrator's guide overview</a>
                        </li>
                    
                        <li >
                            <a href="../command">cbft command-line</a>
                        </li>
                    
                        <li >
                            <a href="../planning">Planning your deployment</a>
                        </li>
                    
                        <li >
                            <a href="../running">Running cbft</a>
                        </li>
                    
                        <li class="active">
                            <a href=".">Clustering cbft</a>
                        </li>
                    
                        <li >
                            <a href="../managing">Managing cbft</a>
                        </li>
                    
                        <li >
                            <a href="../monitoring">Monitoring cbft</a>
                        </li>
                    
                        <li >
                            <a href="../diagnosing">Diagnosing issues</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../links">Links</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../running">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../managing">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#clustering-cbft">Clustering cbft</a></li>
        
            <li><a href="#setting-up-a-couchbase-cfg-provider">Setting up a Couchbase Cfg provider</a></li>
        
            <li><a href="#adding-cbft-nodes">Adding cbft nodes</a></li>
        
            <li><a href="#a-cluster-running-on-a-single-machine">A cluster running on a single machine</a></li>
        
            <li><a href="#availability-of-the-cfg-provider">Availability of the Cfg provider</a></li>
        
            <li><a href="#cbft-node-states">cbft node states</a></li>
        
            <li><a href="#removing-cbft-nodes">Removing cbft nodes</a></li>
        
            <li><a href="#node-identity">Node identity</a></li>
        
            <li><a href="#index-replicas">Index replicas</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="clustering-cbft">Clustering cbft</h1>
<p>To run multiple cbft nodes in a cluster, you need to use a Cfg
provider that supports clustering.</p>
<p>Of note: the default <code>simple</code> Cfg provider that often used for
developer environments is local-only and is non-cluster'able.</p>
<h2 id="setting-up-a-couchbase-cfg-provider">Setting up a Couchbase Cfg provider</h2>
<p>The <code>couchbase</code> Cfg provider supports clustering.</p>
<p>The <code>couchbase</code> Cfg provider uses a Couchbase bucket to store
cbft's configuration data, where multiple cbft nodes that are all
pointed to the same Couchbase bucket will use the Couchbase bucket to
coordinate and rendevous on cbft's cluster-wide configuration
information.</p>
<p>To use the <code>couchbase</code> Cfg provider:</p>
<ul>
<li>
<p>Pick a name for the Couchbase bucket that will be used to store cbft
  cluster configuration data.  For example, <code>cfg-bucket</code>.</p>
</li>
<li>
<p>Using Couchbase's web UI or tools, create the <code>cfg-bucket</code>.</p>
</li>
<li>
<p>Choose the smallest memory resource quota for the <code>cfg-bucket</code>
  (e.g., 100MB RAM).  The amount of data that will be stored in the
  <code>cfg-bucket</code> will be very small, even for large cluster sizes,
  as only cbft cluster configuration and metadata will be maintained
  in the <code>cfg-bucket</code>.</p>
</li>
<li>
<p>Next, start cbft with the <code>couchbase</code> Cfg provider, pointed at
  the <code>cfg-bucket</code>...</p>
<p>./cbft -cfg=couchbase:http://cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091</p>
</li>
</ul>
<h2 id="adding-cbft-nodes">Adding cbft nodes</h2>
<p>On a different machine, you can next start a second cbft node, pointed
at the same, shared <code>cfg-bucket</code>...</p>
<pre><code>./cbft -cfg=couchbase:http://cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091
</code></pre>
<p>Since those two cbft nodes are using the same <code>cfg-bucket</code> as
their Cfg provider, those two cbft nodes are now clustered.</p>
<h2 id="a-cluster-running-on-a-single-machine">A cluster running on a single machine</h2>
<p>Additionally, you can run another cbft node on the same machine, but
specify a different, unique <code>bindHttp</code> port number and
<code>dataDir</code> for each cbft node.  For example:</p>
<pre><code>mkdir -p /data/cbft-9090
mkdir -p /data/cbft-9091
mkdir -p /data/cbft-9092
</code></pre>
<p>Then run the following three commands on the same machine, each in its
own terminal or shell session:</p>
<pre><code>./cbft -cfg=couchbase:http://my-cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091 \
       -dataDir=/data/cbft-9090 \
       -bindHttp=:9090

./cbft -cfg=couchbase:http://my-cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091 \
       -dataDir=/data/cbft-9091 \
       -bindHttp=:9091

./cbft -cfg=couchbase:http://my-cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091 \
       -dataDir=/data/cbft-9092 \
       -bindHttp=:9092
</code></pre>
<p>The above will result in a three node cbft cluster all running on the
same machine.</p>
<p>This can be usefule for testing and for experimenting with cbft
cluster capabilities and behavior, without the cost of needing
separate machines.</p>
<h2 id="availability-of-the-cfg-provider">Availability of the Cfg provider</h2>
<p>If the Couchbase cluster that powers the <code>cfg-bucket</code> goes down,
the cbft nodes will continue to run and service query requests, but
you will not be able to make any cbft cluster configuration changes
(modify index definitions or add/remove cbft nodes) until the
Couchbase cluster returns to online, normal running health.</p>
<p>Related, if the Couchbase <code>cfg-bucket</code> is accidentally deleted,
the cbft nodes will continue to independently run and service query
requests, but you will also not be able to make any cbft cluster
configuration changes (modify index definitions or add/remove cbft
nodes).</p>
<p>Additionally, if the Couchbase <code>cfg-bucket</code> is deleted and
recreated (so ends up in blank, new, empty state, or was flush'ed),
the cbft nodes will also reset to an empty, brand new cbft cluster
without any indexes defined.</p>
<p>Put another way, the Couchbase bucket (<code>cfg-bucket</code>) is considered
the <em>source of truth</em> for the cbft cluster's configuration and is a
key platform dependency of the cbft cluster.</p>
<h2 id="cbft-node-states">cbft node states</h2>
<p>Each cbft node is registered into the cbft cluster with node state.</p>
<p>The node states:</p>
<ul>
<li><code>wanted</code>: a cbft node in wanted state is expected to be part of
  the cluster and will have index partitions automatically assigned to
  it.</li>
</ul>
<p>If a cbft node in wanted state temporarily disappears (e.g. machine or
process stops), it will not lose its previous index partition
assignments, but will be expected to come back soon (machine reboot
and/or process restart) so that it can continue servicing its
previously assigned index partitions.</p>
<p>This design approach was favored because a cbft node might have a
large amount of persistent index data that will be inefficient for
other cbft nodes to rebuild, and having index partition assignments
"bounce around" different cbft nodes would lead to wasteful thrashing
of resources.</p>
<ul>
<li>
<p><code>known</code>: a cbft node in known state is listed in the cluster,
  but will not be assigned any index partitions.</p>
</li>
<li>
<p><code>unknown</code>: this is a node that is not part of the cluster, is
  not actually listed in cbft's cluster configuration data, and by
  definition, will not be assigned any index partitions.</p>
</li>
</ul>
<h2 id="removing-cbft-nodes">Removing cbft nodes</h2>
<p>To remove a cbft node from a cluster, you need to change its
registered state to unknown.  To do so, if you had a cbft node running
previously as...</p>
<pre><code>./cbft -cfg=couchbase:http://my-cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091 \
       -dataDir=/data/cbft-9090 \
       -bindHttp=:9090
</code></pre>
<ul>
<li>
<p>First, stop the cbft node process (e.g., kill the process on linux).</p>
</li>
<li>
<p>Then, run the cbft node with the additional command-line parameters
  of <code>--register=unknown</code></p>
<p>./cbft -cfg=couchbase:http://my-cfg-bucket@couchbase-01:8091 \
       -server=http://couchbase-01:8091 \
       -dataDir=/data/cbft-9090 \
       -bindHttp=:9090 \
       -register=unknown</p>
</li>
</ul>
<p>The key to removing a node with the <code>--register=unknown</code>
command-line parameter is that your invocation must have the same
<code>-bindHttp</code>, <code>-cfg</code>, and node UUID (stored previously in the
dataDir as the <code>cbft.uuid</code> file)</p>
<p>That will move the cbft node into <code>unknown</code> state in the cluster,
and any of the cbft node's previously assigned index partitions will
be re-assigned to other, remaining wanted cbft nodes in the cluster.</p>
<h2 id="node-identity">Node identity</h2>
<p>The cbft node's UUID and bindHttp (address:port) values must be unique
for a new cbft node to join a cluster.</p>
<p>Please see the administrator's guide on <a href="../../running">running cbft
definitions</a> for more information on the node UUID and
bindHTTP values.</p>
<h2 id="index-replicas">Index replicas</h2>
<p>Once you have more than one cbft node in a cluster, then you can
leverage cbft's index replica features.</p>
<p>Index replicas are indexes built up by just re-indexing the data again
from the original data source on a different cbft node.  That is, it
is not chain replication (A -&gt; X -&gt; Y) but is instead star replication
(A -&gt; X; A -&gt; Y).</p>
<p>To enable replicas for an index, you need to set the <code>numReplicas</code>
configuration field for an index definition to greater than 0.  Please
see <code>numReplicas</code> documentation in the developer's guide on <a href="../../../dev-guide/index-definitions">index
definitions</a> for more information.</p>
<hr />
<p>Copyright (c) 2015 Couchbase, Inc.</p>
</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>